{% extends "base.html" %}
{% block title %}Applicants - {{ job.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-users"></i> Applicants for {{ job.title }}</h2>
        <p class="text-muted mb-0">
            <i class="fas fa-building"></i> {{ job.company }} |
            <i class="fas fa-map-marker-alt"></i> {{ job.location }} |
            <i class="fas fa-users"></i> {{ applicants|length }} Applications
        </p>
    </div>
    <div>
        <a href="{{ url_for('hr_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Sort Filter -->
<form method="get" class="mb-3 d-flex align-items-center">
    <label class="me-2">Sort by:</label>
    <select name="sort" class="form-select w-auto" onchange="this.form.submit()">
        <option value="match" {% if sort == 'match' %}selected{% endif %}>Best Match</option>
        <option value="recent" {% if sort == 'recent' %}selected{% endif %}>Most Recent</option>
    </select>
</form>

{% if applicants %}
    {% for applicant in applicants %}
    <div class="card mb-4 border border-success">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div>
                <h5 class="mb-0"><i class="fas fa-user"></i> {{ applicant.name }}</h5>
                <p class="mb-0 text-muted">
                    <i class="fas fa-envelope"></i> {{ applicant.email }}
                    {% if applicant.phone %} | <i class="fas fa-phone"></i> {{ applicant.phone }}{% endif %}
                </p>
            </div>
            <div>
                <span class="badge bg-primary fs-6">{{ "%.1f"|format(applicant.match_percentage) }}% Match</span>
            </div>
        </div>
        <div class="card-body">
            <ul class="list-unstyled mb-3">
                <li><strong>Resume:</strong> {{ applicant.resume_filename.split('_')[-1] }}</li>
                <li><strong>Applied:</strong> {{ applicant.applied_date.strftime('%B %d, %Y') }}</li>
            </ul>

            <h6><i class="fas fa-brain"></i> AI Summary</h6>
            <div class="mb-2">
                <button class="btn btn-sm btn-outline-primary" onclick="generateSummary('{{ applicant._id }}', this)">
                    <i class="fas fa-magic"></i> Generate AI Summary
                </button>
            </div>
            <div id="summary-{{ applicant._id }}" class="alert alert-light" style="display: none;">
                Loading summary...
            </div>

            <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="viewResume('{{ applicant.resume_filename }}')">
                    <i class="fas fa-file-pdf"></i> View Resume
                </button>
                <a class="btn btn-outline-success btn-sm" href="mailto:{{ applicant.email }}">
                    <i class="fas fa-envelope"></i> Contact
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="text-center mt-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h3>No Applications Yet</h3>
        <p>Applicants will appear here once they submit resumes.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
let currentResumeUrl = '';

function viewResume(filename) {
    currentResumeUrl = `/hr/resume/${filename}`;
    document.getElementById('resumeFrame').src = currentResumeUrl;
    const modal = new bootstrap.Modal(document.getElementById('resumeModal'));
    modal.show();
}

function generateSummary(appId, button) {
    const summaryBox = document.getElementById('summary-' + appId);
    summaryBox.style.display = 'block';
    summaryBox.innerHTML = '<div class="text-muted">Generating summary...</div>';
    button.disabled = true;

    fetch(`/api/generate_summary/${appId}`)
        .then(response => response.json())
        .then(data => {
            if (data.summary) {
                summaryBox.innerHTML = `<div class="alert alert-success">${data.summary}</div>`;
            } else {
                summaryBox.innerHTML = '<div class="alert alert-warning">No summary available.</div>';
            }
        })
        .catch(err => {
            summaryBox.innerHTML = '<div class="alert alert-danger">Error loading summary.</div>';
        });
}
</script>

<!-- Resume Modal -->
<div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resumeModalLabel"><i class="fas fa-file-pdf"></i> Resume Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="height: 80vh;">
        <iframe id="resumeFrame" src="" width="100%" height="100%" frameborder="0"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}
